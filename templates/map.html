{% extends "base.html" %}

{% block title %}PFAmsterdam - Map{% endblock %}

{% block head %}
{{ super() }}
<style>
    /* CSS for the map legend */
    .info.legend {
        padding: 6px 8px; font: 14px/16px Arial, Helvetica, sans-serif;
        background: white; background: rgba(255,255,255,0.8);
        box-shadow: 0 0 15px rgba(0,0,0,0.2); border-radius: 5px;
    }
    .legend i {
        width: 18px; height: 18px; float: left;
        margin-right: 8px; opacity: 0.9;
    }
</style>
{% endblock %}


{% block scripts %}
<script src="{{ url_for('static', filename='map/leaflet.js') }}"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
<script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />

<script>
// --- Map Initialization ---
const amsterdamBounds = L.latLngBounds([52.28, 4.70], [52.45, 5.05]);
const map = L.map('map', {
    center: [52.370216, 4.895168], zoom: 12,
    maxBounds: amsterdamBounds, maxBoundsViscosity: 1.0, minZoom: 11
});
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap contributors'
}).addTo(map);

// --- Data Loading ---
const dataFile = "{{ url_for('static', filename='data/data.csv') }}";
fetch(dataFile)
    .then(res => res.text())
    .then(text => {
        const parsedData = Papa.parse(text, { header: true, skipEmptyLines: true }).data;
        plotAllPoints(parsedData);
    });

/**
 * Main function to plot every single data point on the map.
 * @param {Array} data The parsed CSV data
 */
function plotAllPoints(data) {

    let minValue = Infinity;
    let maxValue = -Infinity;
    const allPoints = data.map(row => {
        const point = {
            lat: parseFloat(row.lat),
            lon: parseFloat(row.lon),
            value: parseFloat(row.value),
            originalRow: row
        };
        if (!isNaN(point.value) && point.value > 0) {
            if (point.value < minValue) minValue = point.value;
            if (point.value > maxValue) maxValue = point.value;
        }
        return point;
    }).filter(p => !isNaN(p.lat) && !isNaN(p.lon) && !isNaN(p.value));

    const logMin = minValue > 0 ? Math.log(minValue) : 0;
    const logMax = maxValue > 0 ? Math.log(maxValue) : 1;

    function getDynamicColor(value) {
        if (value <= 0) return 'hsl(120, 100%, 50%)'; // Green
        const logVal = Math.log(value);
        const normalized = (logVal - logMin) / (logMax - logMin);
        const hue = (1 - normalized) * 120; // 0=red, 120=green
        return `hsl(${hue}, 100%, 50%)`;
    }
    
    function getRadius(value) {
        return value > 0 ? Math.log(value + 1) * 2 + 5 : 5;
    }

    const markers = L.markerClusterGroup({
        maxClusterRadius: 100,
        disableClusteringAtZoom: 17,
        iconCreateFunction: function(cluster) {
            const childMarkers = cluster.getAllChildMarkers();
            let totalPfas = 0;
            childMarkers.forEach(marker => {
                if (marker.options.pfasValue) {
                    totalPfas += marker.options.pfasValue;
                }
            });
            const avgPfas = totalPfas / childMarkers.length;
            const clusterColor = getDynamicColor(avgPfas);
            const displaySum = totalPfas > 1000 ? (totalPfas / 1000).toFixed(1) + 'k' : Math.round(totalPfas);
            return new L.DivIcon({
                html: `<div style="background-color: ${clusterColor};"><span>${displaySum}</span></div>`,
                className: 'marker-cluster',
                iconSize: new L.Point(40, 40)
            });
        }
    });

    allPoints.forEach(point => {
        const markerOptions = {
            radius: getRadius(point.value),
            fillColor: getDynamicColor(point.value),
            color: "#000",
            weight: 0.5,
            opacity: 1,
            fillOpacity: 0.8,
            pfasValue: point.value
        };
        
        // ** Here is the updated popup content **
        const popupContent = `
            <div style="font-size: 1.1em; font-weight: bold;">
                Value: ${point.value.toFixed(2)} ${point.originalRow.unit_pfas || ""}
            </div>
            <hr style="margin: 5px 0;">
            <div>
                <b>Location:</b> ${point.originalRow.city}, ${point.originalRow.year}<br>
                <b>Sample Type:</b> ${point.originalRow.matrix}
            </div>
            <hr style="margin: 5px 0;">
            <div style="font-size: 0.9em;">
                <b>Equivalents:</b><br>
                üçé Apples: ${point.originalRow['pfa equivalents in apples'] || 'N/A'}<br>
                üêî Chickens: ${point.originalRow['pfa equivalents in chickens'] || 'N/A'}<br>
                üç∫ Beers: ${point.originalRow['pfa equivalents in beers'] || 'N/A'}
            </div>
        `;
        
        const marker = L.circleMarker([point.lat, point.lon], markerOptions).bindPopup(popupContent);
        markers.addLayer(marker);
    });

    map.addLayer(markers);
    
    const legend = L.control({position: 'bottomright'});
    legend.onAdd = function (map) {
        const div = L.DomUtil.create('div', 'info legend');
        const labels = ['<strong>PFAS Value (ng/kg)</strong><br><small>(Logarithmic Scale)</small>'];
        const grades = [minValue, Math.exp((logMin + logMax) / 2), maxValue];
        for (let i = 0; i < grades.length; i++) {
            const value = grades[i];
            labels.push(
                '<i style="background:' + getDynamicColor(value) + '"></i> ' +
                (value >= 1000 ? (value/1000).toExponential(1) : Math.round(value))
            );
        }
        div.innerHTML = labels.join('<br>');
        return div;
    };
    legend.addTo(map);
}
</script>
{% endblock %}

{% block content %}
<div id="map"></div>
{% endblock %}