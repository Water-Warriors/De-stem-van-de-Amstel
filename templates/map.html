{% extends "base.html" %}

{% block title %}PFAmsterdam - Map{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='map/leaflet.js') }}"></script>
<script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
<script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />

<script>
// --- START: MODIFIED CODE ---

// 1. Define the geographical bounds for the Amsterdam region
const amsterdamBounds = L.latLngBounds(
    [52.28, 4.70], // South-West corner
    [52.45, 5.05]  // North-East corner
);

// 2. Initialize the map with options to lock it to the bounds
const map = L.map('map', {
    center: [52.370216, 4.895168],
    zoom: 12, // Adjusted zoom to better fit the initial view
    maxBounds: amsterdamBounds,
    maxBoundsViscosity: 1.0, // Makes the boundary solid
    minZoom: 11 // Prevents zooming out too far
});

// --- END: MODIFIED CODE ---


L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap contributors'
}).addTo(map);

// Marker cluster group
const markers = L.markerClusterGroup();

// Load CSV/XLSX automatically
const dataFile = "{{ url_for('static', filename='data/data.csv') }}";

if (dataFile.endsWith('.csv')) {
    fetch(dataFile)
        .then(res => res.text())
        .then(text => plotGroupedData(Papa.parse(text, { header: true }).data));
} else if (dataFile.endsWith('.xlsx')) {
    fetch(dataFile)
        .then(res => res.arrayBuffer())
        .then(buf => {
            const wb = XLSX.read(buf, { type: "array" });
            const jsonData = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
            plotGroupedData(jsonData);
        });
}

// Parse PFAS JSON and format nicely
function formatPFAS(pfas_values) {
    if (!pfas_values) return "";
    let str = "";
    try {
        const arr = JSON.parse(pfas_values);
        arr.forEach(p => {
            const val = p.value !== null ? p.value : `<${p.less_than || "100"}`;
            str += `${p.substance} (${p.isomer}): ${val} ${p.unit}<br>`;
        });
    } catch (e) {
        str = pfas_values;
    }
    return str;
}

// Group markers by lat/lon
function plotGroupedData(data) {
    const grouped = {};

    data.forEach(row => {
        const lat = parseFloat(row.lat);
        const lon = parseFloat(row.lon);
        if (isNaN(lat) || isNaN(lon)) return;

        const key = `${lat},${lon}`;
        if (!grouped[key]) grouped[key] = [];
        grouped[key].push(row);
    });

    Object.keys(grouped).forEach(key => {
        const rows = grouped[key];
        const lat = parseFloat(rows[0].lat);
        const lon = parseFloat(rows[0].lon);

        let popupContent = "";
        rows.forEach(r => {
            popupContent += `
                <b>${r.name || ""}</b> (${r.category || ""})<br>
                City: ${r.city || ""}, Country: ${r.country || ""}<br>
                Type: ${r.type || ""}, Sector: ${r.sector || ""}<br>
                Source type: ${r.source_type || ""}, Data method: ${r.data_collection_method || ""}<br>
                Source: <a href="${r.source_url || "#"}" target="_blank">${r.source_text || ""}</a><br>
                Dataset: ${r.dataset_name || ""} (ID: ${r.dataset_id || ""})<br>
                Matrix: ${r.matrix || ""}, Year: ${r.year || ""}<br>
                PFAS Values:<br>${formatPFAS(r.pfas_values)}
                Sum: ${r.pfas_sum || 0} ${r.unit || ""}<hr>
            `;
        });

        const marker = L.marker([lat, lon]).bindPopup(popupContent);
        markers.addLayer(marker);
    });

    map.addLayer(markers);
}
</script>
{% endblock %}

{% block content %}
<div id="map" style="width:100%; height:calc(100vh - 60px);"></div>
{% endblock %}